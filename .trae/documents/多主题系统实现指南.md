# BroadcastChannel 多主题系统实现指南

## 1. 实现概述

本指南提供BroadcastChannel多主题支持系统的具体实现步骤，包括代码示例、配置方法和部署说明。

## 2. 环境准备

### 2.1 环境变量配置

在项目根目录的 `.env` 文件中添加主题相关配置：

```bash
# 现有配置保持不变...

# 主题系统配置
THEME=default                    # 当前使用的主题名称
THEME_DEBUG=false               # 是否开启主题调试模式
THEME_CACHE=true                # 是否启用主题缓存
THEME_FALLBACK=default          # 主题加载失败时的回退主题
```

### 2.2 目录结构创建

在项目根目录创建主题目录结构：

```bash
mkdir theme
mkdir theme/default
mkdir theme/ios
mkdir theme/default/assets
mkdir theme/ios/assets
mkdir theme/default/assets/icons
mkdir theme/default/assets/fonts
mkdir theme/default/assets/images
mkdir theme/ios/assets/icons
mkdir theme/ios/assets/fonts
mkdir theme/ios/assets/images
```

## 3. 核心代码实现

### 3.1 主题管理器 (src/lib/theme-manager.ts)

```typescript
import fs from 'fs/promises'
import path from 'path'
import type { ThemeConfig, ThemeRegistry } from '../types/theme'

export class ThemeManager {
  private static instance: ThemeManager
  private themesPath: string
  private registry: ThemeRegistry | null = null
  private cache: Map<string, ThemeConfig> = new Map()
  private debug: boolean

  constructor() {
    this.themesPath = path.join(process.cwd(), 'theme')
    this.debug = process.env.THEME_DEBUG === 'true'
  }

  static getInstance(): ThemeManager {
    if (!ThemeManager.instance) {
      ThemeManager.instance = new ThemeManager()
    }
    return ThemeManager.instance
  }

  /**
   * 加载主题注册表
   */
  async loadRegistry(): Promise<ThemeRegistry> {
    if (!this.registry) {
      try {
        const registryPath = path.join(this.themesPath, 'theme-registry.json')
        const registryContent = await fs.readFile(registryPath, 'utf-8')
        this.registry = JSON.parse(registryContent)
        this.log('主题注册表加载成功')
      } catch (error) {
        this.log('主题注册表加载失败，使用默认配置', error)
        this.registry = {
          themes: [
            { name: 'default', path: './default', enabled: true }
          ],
          defaultTheme: 'default'
        }
      }
    }
    return this.registry
  }

  /**
   * 加载指定主题
   */
  async loadTheme(themeName: string): Promise<ThemeConfig> {
    // 检查缓存
    if (process.env.THEME_CACHE === 'true' && this.cache.has(themeName)) {
      this.log(`从缓存加载主题: ${themeName}`)
      return this.cache.get(themeName)!
    }

    try {
      const registry = await this.loadRegistry()
      const themeInfo = registry.themes.find(t => t.name === themeName)

      if (!themeInfo || !themeInfo.enabled) {
        throw new Error(`主题 ${themeName} 不存在或已禁用`)
      }

      const themePath = path.join(this.themesPath, themeInfo.path, 'theme.json')
      const themeContent = await fs.readFile(themePath, 'utf-8')
      const themeConfig: ThemeConfig = JSON.parse(themeContent)

      // 验证主题配置
      this.validateThemeConfig(themeConfig)

      // 加载CSS变量
      await this.loadThemeStyles(themeConfig, themeInfo.path)

      // 缓存主题配置
      if (process.env.THEME_CACHE === 'true') {
        this.cache.set(themeName, themeConfig)
      }

      this.log(`主题 ${themeName} 加载成功`)
      return themeConfig
    } catch (error) {
      this.log(`主题 ${themeName} 加载失败`, error)
      throw error
    }
  }

  /**
   * 加载主题样式文件
   */
  private async loadThemeStyles(themeConfig: ThemeConfig, themePath: string): Promise<void> {
    const styleFiles = ['variables.css', 'components.css', 'custom.css']
    
    for (const styleFile of styleFiles) {
      try {
        const stylePath = path.join(this.themesPath, themePath, styleFile)
        const styleContent = await fs.readFile(stylePath, 'utf-8')
        
        // 将样式内容添加到主题配置中
        if (!themeConfig.styles) {
          themeConfig.styles = {}
        }
        themeConfig.styles[styleFile] = styleContent
      } catch (error) {
        // 样式文件不存在是正常的，只有variables.css是必需的
        if (styleFile === 'variables.css') {
          throw new Error(`必需的样式文件 ${styleFile} 不存在`)
        }
      }
    }
  }

  /**
   * 验证主题配置
   */
  private validateThemeConfig(config: ThemeConfig): void {
    const requiredFields = ['name', 'displayName', 'version', 'variables']
    
    for (const field of requiredFields) {
      if (!config[field as keyof ThemeConfig]) {
        throw new Error(`主题配置缺少必需字段: ${field}`)
      }
    }

    // 验证必需的CSS变量
    const requiredVariables = [
      '--background-color',
      '--foreground-color',
      '--highlight-color',
      '--border-color',
      '--cell-background-color'
    ]

    for (const variable of requiredVariables) {
      if (!config.variables[variable]) {
        throw new Error(`主题配置缺少必需的CSS变量: ${variable}`)
      }
    }
  }

  /**
   * 获取当前主题
   */
  getCurrentTheme(): string {
    return process.env.THEME || 'default'
  }

  /**
   * 获取可用主题列表
   */
  async getAvailableThemes(): Promise<string[]> {
    const registry = await this.loadRegistry()
    return registry.themes
      .filter(theme => theme.enabled)
      .map(theme => theme.name)
  }

  /**
   * 清除缓存
   */
  clearCache(): void {
    this.cache.clear()
    this.log('主题缓存已清除')
  }

  /**
   * 调试日志
   */
  private log(message: string, error?: any): void {
    if (this.debug) {
      console.log(`[ThemeManager] ${message}`)
      if (error) {
        console.error(error)
      }
    }
  }
}
```

### 3.2 主题类型定义 (src/types/theme.ts)

```typescript
export interface ThemeConfig {
  name: string
  displayName: string
  description?: string
  version: string
  author?: string
  homepage?: string
  license?: string
  keywords?: string[]
  variables: Record<string, string>
  styles?: Record<string, string>
  assets?: {
    icons?: string[]
    fonts?: string[]
    images?: string[]
  }
  compatibility?: {
    minVersion?: string
    maxVersion?: string
  }
  features?: {
    darkMode?: boolean
    animations?: boolean
    customFonts?: boolean
  }
}

export interface ThemeRegistry {
  themes: Array<{
    name: string
    path: string
    enabled: boolean
  }>
  defaultTheme: string
}

export interface ThemeContext {
  theme: ThemeConfig
  themeName: string
}
```

### 3.3 主题中间件 (src/middleware/theme.ts)

```typescript
import type { MiddlewareResponseHandler } from 'astro'
import { ThemeManager } from '../lib/theme-manager'
import type { ThemeContext } from '../types/theme'

export const onRequest: MiddlewareResponseHandler = async (context, next) => {
  const themeManager = ThemeManager.getInstance()
  const themeName = process.env.THEME || 'default'
  const fallbackTheme = process.env.THEME_FALLBACK || 'default'

  try {
    // 尝试加载指定主题
    const themeConfig = await themeManager.loadTheme(themeName)
    
    // 将主题信息添加到上下文
    const themeContext: ThemeContext = {
      theme: themeConfig,
      themeName
    }
    
    context.locals.themeContext = themeContext
    
    // 设置响应头，用于客户端主题识别
    context.response.headers.set('X-Theme-Name', themeName)
    context.response.headers.set('X-Theme-Version', themeConfig.version)
    
  } catch (error) {
    console.warn(`主题 ${themeName} 加载失败，回退到 ${fallbackTheme}:`, error)
    
    try {
      // 回退到默认主题
      const fallbackConfig = await themeManager.loadTheme(fallbackTheme)
      
      const themeContext: ThemeContext = {
        theme: fallbackConfig,
        themeName: fallbackTheme
      }
      
      context.locals.themeContext = themeContext
      context.response.headers.set('X-Theme-Name', fallbackTheme)
      context.response.headers.set('X-Theme-Version', fallbackConfig.version)
      context.response.headers.set('X-Theme-Fallback', 'true')
      
    } catch (fallbackError) {
      console.error('回退主题也加载失败:', fallbackError)
      throw new Error('无法加载任何主题，请检查主题配置')
    }
  }

  return next()
}
```

### 3.4 主题样式注入组件 (src/components/theme-styles.astro)

```astro
---
import type { ThemeContext } from '../types/theme'

interface Props {
  themeContext: ThemeContext
}

const { themeContext } = Astro.props
const { theme } = themeContext

// 生成CSS变量字符串
const cssVariables = Object.entries(theme.variables)
  .map(([key, value]) => `  ${key}: ${value};`)
  .join('\n')

// 获取主题样式
const variablesCSS = theme.styles?.['variables.css'] || ''
const componentsCSS = theme.styles?.['components.css'] || ''
const customCSS = theme.styles?.['custom.css'] || ''
---

<!-- 注入CSS变量 -->
<style is:global define:vars={{ ...theme.variables }}>
  :root {
{cssVariables}
  }
</style>

<!-- 注入主题样式 -->
{variablesCSS && (
  <style is:global set:html={variablesCSS}></style>
)}

{componentsCSS && (
  <style is:global set:html={componentsCSS}></style>
)}

{customCSS && (
  <style is:global set:html={customCSS}></style>
)}

<!-- 主题元数据 -->
<meta name="theme-name" content={theme.name} />
<meta name="theme-version" content={theme.version} />
{theme.author && <meta name="theme-author" content={theme.author} />}
```

### 3.5 更新基础布局 (src/layouts/base.astro)

```astro
---
import ThemeStyles from '../components/theme-styles.astro'
import type { ThemeContext } from '../types/theme'

// 从中间件获取主题上下文
const themeContext = Astro.locals.themeContext as ThemeContext

interface Props {
  title?: string
  description?: string
}

const { title, description } = Astro.props
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title || 'BroadcastChannel'}</title>
    {description && <meta name="description" content={description} />}
    
    <!-- 注入主题样式 -->
    <ThemeStyles themeContext={themeContext} />
    
    <!-- 原有样式文件 -->
    <link rel="stylesheet" href="/src/assets/normalize.css" />
    <link rel="stylesheet" href="/src/assets/global.css" />
    <!-- 注意：不再直接引入style.css，改为通过主题系统加载 -->
  </head>
  <body>
    <div id="wrapper">
      <slot />
    </div>
    
    <!-- 主题切换脚本 -->
    <script>
      // 客户端主题信息
      window.THEME_INFO = {
        name: document.querySelector('meta[name="theme-name"]')?.getAttribute('content'),
        version: document.querySelector('meta[name="theme-version"]')?.getAttribute('content'),
        author: document.querySelector('meta[name="theme-author"]')?.getAttribute('content')
      }
      
      // 主题切换函数（用于未来的客户端切换功能）
      window.switchTheme = function(themeName) {
        // 这里可以实现客户端主题切换逻辑
        console.log('切换到主题:', themeName)
      }
    </script>
  </body>
</html>
```

## 4. 默认主题配置

### 4.1 创建默认主题 (theme/default/theme.json)

```json
{
  "name": "default",
  "displayName": "默认主题",
  "description": "BroadcastChannel的默认主题风格",
  "version": "1.0.0",
  "author": "BroadcastChannel Team",
  "variables": {
    "--background-color": "#f4f1ec",
    "--foreground-color": "#000000",
    "--highlight-color": "orangered",
    "--box-border-radius": "3px",
    "--media-border-radius": "8px",
    "--dot-size": "8px",
    "--shadows": "0 1px 2px rgba(0, 0, 0, 0.02), 0 2px 4px rgba(0, 0, 0, 0.02), 0 4px 8px rgba(0, 0, 0, 0.02), 0 8px 16px rgba(0, 0, 0, 0.02)",
    "--box-margin": "10px",
    "--border-color": "rgba(0, 0, 0, 0.05)",
    "--link-color": "var(--highlight-color)",
    "--icon-hover-filter": "invert(51%) sepia(0%) saturate(0%) hue-rotate(23deg) brightness(90%) contrast(90%)",
    "--icon-secondary-filter": "invert(97%) sepia(0%) saturate(0%) hue-rotate(129deg) brightness(86%) contrast(88%)",
    "--cell-background-color": "#fff",
    "--code-background-color": "#f9f9f9",
    "--secondary-color": "#999"
  },
  "features": {
    "darkMode": false,
    "animations": true,
    "customFonts": false
  }
}
```

### 4.2 默认主题样式 (theme/default/variables.css)

```css
/* 将现有的 src/assets/style.css 中的 :root 变量移动到这里 */
:root {
  --background-color: #f4f1ec;
  --foreground-color: #000000;
  --highlight-color: orangered;
  --box-border-radius: 3px;
  --media-border-radius: 8px;
  --dot-size: 8px;
  --shadows: 0 1px 2px rgba(0, 0, 0, 0.02), 0 2px 4px rgba(0, 0, 0, 0.02),
    0 4px 8px rgba(0, 0, 0, 0.02), 0 8px 16px rgba(0, 0, 0, 0.02);
  --box-margin: 10px;
  --border-color: rgba(0, 0, 0, 0.05);
  --link-color: var(--highlight-color);
  --icon-hover-filter: invert(51%) sepia(0%) saturate(0%) hue-rotate(23deg)
    brightness(90%) contrast(90%);
  --icon-secondary-filter: invert(97%) sepia(0%) saturate(0%) hue-rotate(129deg)
    brightness(86%) contrast(88%);
  --cell-background-color: #fff;
  --code-background-color: #f9f9f9;
  --secondary-color: #999;
}
```

## 5. iOS主题实现

### 5.1 iOS主题配置 (theme/ios/theme.json)

```json
{
  "name": "ios",
  "displayName": "iOS风格主题",
  "description": "模仿iOS系统设计风格的主题",
  "version": "1.0.0",
  "author": "BroadcastChannel Team",
  "keywords": ["ios", "apple", "mobile", "clean"],
  "variables": {
    "--background-color": "#f2f2f7",
    "--foreground-color": "#000000",
    "--highlight-color": "#007AFF",
    "--secondary-color": "#8E8E93",
    "--border-color": "rgba(60, 60, 67, 0.12)",
    "--cell-background-color": "#ffffff",
    "--code-background-color": "#f2f2f7",
    "--box-border-radius": "10px",
    "--media-border-radius": "12px",
    "--dot-size": "6px",
    "--box-margin": "16px",
    "--shadows": "0 1px 3px rgba(0, 0, 0, 0.1)",
    "--link-color": "var(--highlight-color)",
    "--icon-hover-filter": "invert(27%) sepia(51%) saturate(2878%) hue-rotate(200deg) brightness(104%) contrast(97%)",
    "--icon-secondary-filter": "invert(56%) sepia(8%) saturate(878%) hue-rotate(201deg) brightness(92%) contrast(86%)"
  },
  "features": {
    "darkMode": false,
    "animations": true,
    "customFonts": true
  }
}
```

### 5.2 iOS主题样式 (theme/ios/variables.css)

```css
/* iOS风格字体 */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
  /* iOS风格颜色 */
  --background-color: #f2f2f7;
  --foreground-color: #000000;
  --highlight-color: #007AFF;
  --secondary-color: #8E8E93;
  --border-color: rgba(60, 60, 67, 0.12);
  --cell-background-color: #ffffff;
  --code-background-color: #f2f2f7;
  
  /* iOS风格圆角 */
  --box-border-radius: 10px;
  --media-border-radius: 12px;
  
  /* iOS风格间距 */
  --box-margin: 16px;
  --dot-size: 6px;
  
  /* iOS风格阴影 */
  --shadows: 0 1px 3px rgba(0, 0, 0, 0.1);
  
  /* iOS风格字体 */
  --heading-font: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
  --body-font: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Text', sans-serif;
}

/* 应用iOS风格字体 */
body {
  font-family: var(--body-font);
  font-weight: 400;
  letter-spacing: -0.01em;
}

h1, h2, h3, h4, h5, h6 {
  font-family: var(--heading-font);
  font-weight: 600;
  letter-spacing: -0.02em;
}

/* iOS风格按钮 */
.nav-link {
  font-weight: 500;
  letter-spacing: -0.01em;
}

/* iOS风格卡片 */
.item {
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
}
```

### 5.3 iOS主题组件样式 (theme/ios/components.css)

```css
/* iOS风格的组件样式覆盖 */

/* 更圆润的头像 */
.header-avatar,
.breadcrumb-avatar {
  border-radius: 50%;
  border-width: 2px;
}

/* iOS风格的导航链接 */
.nav-link {
  padding: 12px 16px;
  font-weight: 500;
  transition: all 0.2s ease;
}

.nav-link:hover {
  background-color: rgba(0, 122, 255, 0.1);
  transform: translateY(-1px);
}

/* iOS风格的时间显示 */
.time-box > .time {
  font-weight: 500;
  font-size: 13px;
}

/* iOS风格的文本框 */
.text-box {
  line-height: 1.5;
  font-weight: 400;
}

/* iOS风格的标签 */
.tag-box {
  font-weight: 500;
}

/* iOS风格的模态框 */
#modal {
  backdrop-filter: blur(40px);
  -webkit-backdrop-filter: blur(40px);
}

/* iOS风格的图片 */
.image-box > img,
.video-box video,
.audio-box audio {
  border-radius: var(--media-border-radius);
}
```

## 6. 主题注册表配置

### 6.1 创建主题注册表 (theme/theme-registry.json)

```json
{
  "themes": [
    {
      "name": "default",
      "path": "./default",
      "enabled": true
    },
    {
      "name": "ios",
      "path": "./ios",
      "enabled": true
    }
  ],
  "defaultTheme": "default"
}
```

## 7. 部署和测试

### 7.1 更新Astro配置

在 `astro.config.mjs` 中注册主题中间件：

```javascript
import { defineConfig } from 'astro/config'
// ... 其他导入

export default defineConfig({
  // ... 现有配置
  
  // 注册中间件
  integrations: [
    // ... 现有集成
  ],
  
  // 确保主题文件可以被访问
  vite: {
    // ... 现有配置
    publicDir: 'public',
    assetsInclude: ['**/*.json', '**/*.css']
  }
})
```

### 7.2 更新中间件注册 (src/middleware.js)

```javascript
import { sequence } from 'astro/middleware'
import { onRequest as themeMiddleware } from './middleware/theme'

// 如果有其他中间件，使用sequence组合
export const onRequest = sequence(
  themeMiddleware
  // ... 其他中间件
)
```

### 7.3 测试主题切换

1. **测试默认主题**：
   ```bash
   # 不设置THEME环境变量，应该使用default主题
   npm run dev
   ```

2. **测试iOS主题**：
   ```bash
   # 设置THEME环境变量为ios
   THEME=ios npm run dev
   ```

3. **测试主题回退**：
   ```bash
   # 设置一个不存在的主题，应该回退到default
   THEME=nonexistent npm run dev
   ```

4. **测试调试模式**：
   ```bash
   # 开启调试模式查看详细日志
   THEME_DEBUG=true npm run dev
   ```

### 7.4 验证主题效果

访问 `http://localhost:4321` 并检查：

1. **页面样式**：确认主题样式正确应用
2. **浏览器开发者工具**：检查CSS变量是否正确设置
3. **响应头**：确认 `X-Theme-Name` 等头部信息
4. **控制台**：查看主题加载日志（调试模式下）

## 8. 故障排除

### 8.1 常见问题

1. **主题不生效**：
   - 检查环境变量是否正确设置
   - 确认主题文件路径正确
   - 查看控制台错误信息

2. **样式冲突**：
   - 确保CSS变量名称一致
   - 检查样式优先级
   - 使用浏览器开发者工具调试

3. **性能问题**：
   - 启用主题缓存 `THEME_CACHE=true`
   - 优化CSS文件大小
   - 检查资源加载时间

### 8.2 调试技巧

1. **启用调试模式**：
   ```bash
   THEME_DEBUG=true npm run dev
   ```

2. **清除主题缓存**：
   ```javascript
   // 在浏览器控制台执行
   fetch('/api/theme/clear-cache', { method: 'POST' })
   ```

3. **检查主题配置**：
   ```javascript
   // 在浏览器控制台查看主题信息
   console.log(window.THEME_INFO)
   ```

## 9. 后续扩展

### 9.1 计划功能

1. **客户端主题切换**：支持用户在界面上切换主题
2. **暗色模式支持**：自动检测系统暗色模式偏好
3. **主题市场**：支持在线下载和安装主题
4. **主题编辑器**：可视化主题编辑工具

### 9.2 API扩展

可以添加以下API端点：

- `GET /api/theme/list` - 获取可用主题列表
- `POST /api/theme/switch` - 切换主题
- `GET /api/theme/preview` - 主题预览
- `POST /api/theme/install` - 安装新主题

这样就完成了BroadcastChannel项目的多主题支持系统实现。